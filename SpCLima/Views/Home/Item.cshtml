@model SpClima.ViewModels.ItemVM
@{
    ViewData["Title"] = Model.Item.Titulo;
}

<div class="container my-5">
    <div class="row">
        <!-- Coluna principal: detalhes do item -->
        <div class="col-lg-8">
            <div class="card mb-4 shadow-sm">
                <img src="@Model.Item.ImagemUrl" class="card-img-top" alt="@Model.Item.Titulo">
                <div class="card-body">
                    <h2 class="card-title">@Model.Item.Titulo</h2>
                    <p class="card-text">@Model.Item.Descricao</p>

                    <hr />

                    <h5>Escolha a variação:</h5>
                    <div class="mb-3">
                        <select id="selectVariacao" class="form-select">
                            <option value="">-- Selecione --</option>
                            @foreach (var v in Model.Item.Variacoes)
                            {
                                <option value="@v.Preco.ToString("F2")">@v.Nome — R$ @v.Preco.ToString("N2")</option>
                            }
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="obsPersonalizada" class="form-label">Observações (ex: “220V”, “2º andar”)</label>
                        <textarea id="obsPersonalizada" class="form-control" rows="2" placeholder="Detalhes adicionais…"></textarea>
                    </div>

                    <div class="mb-4 d-flex justify-content-between align-items-center">
                        <h4>Total estimado:</h4>
                        <h3 id="totalEstimado">R$ 0,00</h3>
                    </div>

                    <button id="btnChat" class="btn btn-success btn-lg w-100" disabled>
                        <i class="bi bi-whatsapp"></i> Falar com o técnico
                    </button>
                </div>
            </div>
        </div>

        <!-- Coluna lateral: resumo rápido -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-body">
                    <h5 class="card-title">Resumo</h5>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item"><strong>Serviço:</strong> @Model.Item.Titulo</li>
                        <li class="list-group-item"><strong>Variação:</strong> <span id="resVariacao">—</span></li>
                        <li class="list-group-item"><strong>Observações:</strong> <span id="resObs">—</span></li>
                        <li class="list-group-item"><strong>Total:</strong> <span id="resTotal">R$ 0,00</span></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Seção de outros serviços -->
    <div class="mt-5">
        <h3>Outros serviços</h3>
        <div class="row">
            @foreach(var outItem in Model.Outros)
            {
                <div class="col-md-3 mb-4">
                    <div class="card h-100">
                        <img src="@outItem.ImagemUrl" class="card-img-top" alt="@outItem.Titulo">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">@outItem.Titulo</h5>
                            <p class="card-text text-truncate">@outItem.Descricao</p>
                            <a asp-action="Details"
                               asp-route-id="@outItem.Id"
                               class="btn btn-outline-primary mt-auto">Ver detalhes</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const selectVar = document.getElementById('selectVariacao');
        const obsTxt    = document.getElementById('obsPersonalizada');
        const totalEl   = document.getElementById('totalEstimado');
        const btnChat   = document.getElementById('btnChat');

        const resVar    = document.getElementById('resVariacao');
        const resObs    = document.getElementById('resObs');
        const resTotal  = document.getElementById('resTotal');

        function updateSummary() {
            const preco = parseFloat(selectVar.value || 0);
            const obs   = obsTxt.value.trim();

            if (preco > 0) {
                totalEl.textContent = 'R$ ' + preco.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                btnChat.disabled    = false;
            } else {
                totalEl.textContent = 'R$ 0,00';
                btnChat.disabled    = true;
            }

            // Atualiza o resumo lateral
            resVar.textContent   = selectVar.options[selectVar.selectedIndex]?.text || '—';
            resObs.textContent   = obs || '—';
            resTotal.textContent = totalEl.textContent;
        }

        selectVar.addEventListener('change', updateSummary);
        obsTxt.addEventListener('input', updateSummary);

        btnChat.addEventListener('click', () => {
            const mensagem = encodeURIComponent(
                `Olá, gostaria de um orçamento para:\n` +
                `- Serviço: @Model.Item.Titulo\n` +
                `- Variação: ${resVar.textContent}\n` +
                `- Observações: ${resObs.textContent}\n` +
                `Total estimado: ${resTotal.textContent}`
            );
            window.open(`https://wa.me/55SEUNUMERO?text=${mensagem}`, '_blank');
        });
    </script>
}
